<!DOCTYPE html>
<html lang="en">

    {% include "partials/header.html" %}

    <body>

        {% set founder_name = siteinfo[0].bioname %}
        {% set founder_bio = siteinfo[0].bio %}
        {% set founder_photo = siteinfo[0].biophoto %}
        {% set mission = siteinfo[0].mission %}
        {% set vision = siteinfo[0].vision %}
        {% set description = siteinfo[0].description %}
        {% set telephone = siteinfo[0].telephone %}
        {% set company_email = siteinfo[0].email %}
        {% set company_address = siteinfo[0].address %}
        {% set logo = siteinfo[0].logo %}
        {% set facebook_url = siteinfo[0].socialmedia.facebook %}
        {% set twitter_url = siteinfo[0].socialmedia.twitter %}
        {% set instagram_url = siteinfo[0].socialmedia.instagram %}

        <div class="site-wrap">
            {% include "partials/nav.html" %}

            {% block content %}{% endblock %}

            {% include "partials/footer.njk" %}
        </div>

        <!-- Bootstrap core JavaScript -->

        
        <script src="/assets/js/jquery-3.3.1.min.js"></script>
        <script src="/assets/js/jquery-ui.js"></script>
        <script src="/assets/js/popper.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/bootstrap-input-spinner.js"></script>
        <script src="/assets/js/owl.carousel.min.js"></script>
        <script src="/assets/js/jquery.magnific-popup.min.js"></script>
        <script src="/assets/js/aos.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/8.11.8/sweetalert2.all.min.js"></script>

        <script src="/assets/js/main.js"></script>
        <script>
            if (window.netlifyIdentity) {
                window
                    .netlifyIdentity
                    .on("init", user => {
                        if (!user) {
                            window
                                .netlifyIdentity
                                .on("login", () => {
                                    document.location.href = "/admin/";
                                });
                        }
                    });
            }
        </script>
        <script>

            var items = [];
            var products = [];
            $.getJSON("/assets/data/products.json", function (data) {

                console.log('json data',data);
                localStorage.setItem('products',JSON.stringify(data))
                //$.each(data, function (key, val) {
                //    items.push(data)
                //});

                //console.log(items)
                //products = items[0].products;
                //console.log(products)
            });

            var infoModal = $("#myModal");
            $(".openModal").on("click", function () {
                console.log(this.value);
                var product_id = parseInt(this.value) - 1
                console.log(products[product_id])
                // htmlData = $(this)
                //   .find(".profile")
                //   .html();
                infoModal
                    .find(".modal-title")
                    .html(products[product_id].name);
                infoModal
                    .find(".modal-description")
                    .html(products[product_id].ingredients);
                infoModal
                    .find(".product-directions")
                    .html(products[product_id].directions);
                infoModal
                    .find(".product-disclaimer")
                    .html(products[product_id].disclaimer);
                infoModal.modal("show");
                return false;
            });
        </script>
        <script>

            function getFormData(form){
                var unindexed_array = $(form).serializeArray();
                var indexed_array = {};

                $.map(unindexed_array, function(n, i){
                    indexed_array[n['name']] = n['value'];
                });

                return indexed_array;
            }

            function savePrescriptionInfo(form){
                //var data = JSON.stringify($(form).serializeArray()); //  <-----------
                var prescription_data = getFormData(form)
                console.log(prescription_data)
                //console.log(JSON.parse(data));
                return false; //don't submit
            }

            function saveShippingInfo(form){
                //var data = JSON.stringify($(form).serializeArray()); //  <-----------

                var shipping_data = getFormData(form)
                console.log(shipping_data);
                return false; //don't submit
            }

            function addToCart(){
                var product_id = document.getElementById("item_id").innerHTML;
                console.log('clicked on product with id: ', product_id)

                var products = JSON.parse(localStorage.getItem('products'))
                console.log('current product', products[product_id])
                //return;
                var product_info = products[product_id]

                //console.log(id, name, price, sku)
                var item_quantity = document.getElementById("item_quantity").value;
                console.log(item_quantity)

                var data_array = JSON.parse(localStorage.getItem("cart_items"))
                console.log(data_array)

                if(!data_array){
                    data_array = []
                }

                data_array.push({
                    id: product_info.id,
                    sku: product_info.stripe_sku,
                    image:"",
                    product: product_info.title,
                    price: product_info.price,
                    quantity: item_quantity
                });
                console.log(data_array)

                if(data_array.length > 0){
                    cart_count.innerHTML = data_array.length
                    cart_count.style.visibility = "visible"
                }
                //return
                localStorage.setItem("cart_items",JSON.stringify(data_array))

                

                //window.location = 'cart.html'

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'You have added '+item_quantity+' '+product_info.title+'(s) to your cart!',
                    footer: '<a href="cart.html">View Items in Cart</a>'
                    })

            }

            function deleteRow(el, item_id) {
                console.log('delete row',el.parentNode)
                // while there are parents, keep going until reach TR 
                while (el.parentNode && el.tagName.toLowerCase() != 'tr') {
                    el = el.parentNode;
                }

                // If el has a parentNode it must be a TR, so delete it
                // Don't delte if only 3 rows left in table
                if (el.parentNode) {
                    el.parentNode.removeChild(el);
                }

                var cart_items = JSON.parse(localStorage.getItem("cart_items"))
                var new_items = cart_items.filter((item) => item.id !== item_id)
                console.log(new_items)

                if(new_items.length > 0){
                    cart_count.innerHTML = data_array.length
                    //cart_count.style.visibility = "visible"
                }else{
                    cart_count.innerHTML = 0
                    cart_count.style.visibility="hidden"
                }

                localStorage.setItem("cart_items",JSON.stringify(new_items))
            }


        </script>

        <script>
            
            //DISPLAY ITEMS IN CART
            var data_array = JSON.parse(localStorage.getItem("cart_items"))
            console.log(data_array)

            var cart_count = document.getElementById("cart_count")
            if(data_array.length > 0){
                cart_count.innerHTML = data_array.length
                cart_count.style.visibility = "visible"
            }
            

            var table = document.getElementById("shopping-cart");
            var total_cost = 0;

            for(var i=0; i<data_array.length; i++){

                // Create an empty <tr> element and add it to the 1st position of the table:
                var row = table.insertRow(-1);

                // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);

                // Add some text to the new cells:
                cell1.innerHTML = "<a href='shop-single.html?id="+data_array[i].id+"'>"+data_array[i].product+"</a>";
                cell2.innerHTML = "$ "+parseFloat(data_array[i].price).toFixed(2);
                cell3.innerHTML = data_array[i].quantity;
                cell4.innerHTML = "<button type='button' product_id='"+data_array[i].id+"' class='btn btn-primary btn-sm' onclick=\"deleteRow(this,'"+data_array[i].id+"')\">X</button>";

                total_cost += parseFloat(data_array[i].price)*parseFloat(data_array[i].quantity)
            }

            console.log(total_cost)

            document.getElementById('sub_total').innerHTML = "$ "+parseFloat(total_cost).toFixed(2)
            document.getElementById('final_total').innerHTML = "$ "+parseFloat(total_cost).toFixed(2)

            
        </script>

        <!-- Load Stripe.js on your website. -->
        <script src="https://js.stripe.com/v3"></script>
        
        <script>
            (function () {
              //var stripe = Stripe('pk_test_ujOhdb12UPkmWbya4ghecbTW');
              //var stripe = Stripe('pk_live_HEnlS2Pd3aY9uYctGiws23fs');
              // Richieann
              var stripe = Stripe('pk_live_6JxSfq1ltlJKfDJfMj2cTGNn00fmKxrq3i');

              var checkoutButton = document.getElementById('checkout-button');
              checkoutButton.addEventListener('click', function () {

                var cart_items = JSON.parse(localStorage.getItem("cart_items"))
                var checkout_array = []
                cart_items.map(item=>checkout_array.push({sku:item.sku, quantity: parseInt(item.quantity)}))
                console.log('checkout',checkout_array)
                    //return
                // When the customer clicks on the button, redirect
                // them to Checkout.
                stripe.redirectToCheckout({
                  
                  //live items
                  //items: [{ sku: 'sku_GZ2BWHOxgx2TSg', quantity: 1 }],
                  //Richieann
                  //items: [{ sku: 'sku_GZ5MJ23DUG6rCH', quantity: 1 }],
                  //test items
                  //items: [{ sku: 'sku_GeHtCV10DKJRZn', quantity: 1 },{sku: 'sku_GeINSvjcP8C0ck', quantity: 1}],
                  items: checkout_array,

                  // Do not rely on the redirect to the successUrl for fulfilling
                  // purchases, customers may not always reach the success_url after
                  // a successful payment.
                  // Instead use one of the strategies described in
                  // https://stripe.com/docs/payments/checkout/fulfillment
                  successUrl: 'https://sunniesbyrichie.com/success.html',
                  cancelUrl: 'https://sunniesbyrichie.com/cart.html',
                })
                  .then(function (result) {
                    if (result.error) {
                      // If `redirectToCheckout` fails due to a browser or network
                      // error, display the localized error message to your customer.
                      var displayError = document.getElementById('error-message');
                      displayError.textContent = result.error.message;
                    }

                    //TODO: Send email with customer prescription info
                  });
              });
            })();
          </script>
    </body>
</html>